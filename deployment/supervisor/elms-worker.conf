; ============================================
; eLMS Queue Workers - Supervisor Configuration
; ============================================
; This file configures two separate queue workers:
; 1. Default queue - handles most jobs (notifications, emails, etc.)
; 2. Video encoding queue - handles HLS video encoding (resource-intensive)
;
; The separation ensures video encoding doesn't block other jobs
; and allows resource management for heavy encoding tasks.
;
; --------------------------------------------
; DEPLOYMENT INSTRUCTIONS
; --------------------------------------------
; 1. Find your supervisor config directory first:
;    sudo grep -A5 "\[include\]" /etc/supervisor/supervisord.conf
;
; 2. Copy this file to the directory shown above
;    Common locations:
;    - Ubuntu/Debian:    /etc/supervisor/conf.d/
;    - CentOS/RHEL:      /etc/supervisord.d/
;    - aaPanel/BT Panel: /www/server/panel/plugin/supervisor/profile/
;
; 3. Rename if needed:
;    - If supervisor looks for *.ini files, rename to elms-worker.ini
;    - If supervisor looks for *.conf files, keep as elms-worker.conf
;
; 4. Update the paths below:
;    - directory: Change /var/www/html to your app path
;    - user: Change www-data to your web server user
;    - stdout_logfile: Update log paths if needed
;
; 5. Load the configuration:
;    sudo supervisorctl reread
;    sudo supervisorctl update
;    sudo supervisorctl status
;
; See deployment/supervisor/README.md for detailed instructions
; ============================================

; --------------------------------------------
; Default Queue Worker
; --------------------------------------------
; Handles: notifications, emails, and general jobs
; Workers: 2 processes (adjust based on server capacity)
; Priority: Processes default queue jobs first
[program:elms-default-worker]
process_name=%(program_name)s_%(process_num)02d
command=php artisan queue:work --queue=default --sleep=3 --tries=3 --max-time=3600
directory=/var/www/html
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/var/www/html/storage/logs/worker-default.log
stdout_logfile_maxbytes=10MB
stopwaitsecs=3600

; --------------------------------------------
; Video Encoding Queue Worker
; --------------------------------------------
; Handles: HLS video encoding jobs only
; Workers: 1 process (encoding is CPU/memory intensive)
; Timeout: 2 hours for large video files
;
; NOTE: Only 1 worker to prevent server overload during encoding.
; Increase numprocs only if server has sufficient resources (8+ CPU cores, 8GB+ RAM)
[program:elms-video-worker]
process_name=%(program_name)s_%(process_num)02d
command=php artisan queue:work --queue=video-encoding --sleep=10 --tries=1 --max-time=7200 --memory=512
directory=/var/www/html
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=1
redirect_stderr=true
stdout_logfile=/var/www/html/storage/logs/worker-video.log
stdout_logfile_maxbytes=10MB
stopwaitsecs=7200
